{{ define "main" }}

<section class="container mx-auto">
    <div class="flex">
        <div class="flex-1 ">
            <div class="min-h-screen" id="map"></div>
        </div>
        <div class="flex-1 w-32 p-1">
            <div id="images-current-extent" class="grid grid-cols-2 md:grid-cols-3 gap-4 images-current-extent">

            </div>
        </div>
    </div>
</section>
{{ end }}

{{ define "header" }}
<script src='https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js'></script>
<link href='https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css' rel='stylesheet' />
{{ end }}

{{ define "footer" }}
<script>
    mapboxgl.accessToken = '{{.Site.Params.MAPBOXTOKEN}}';
    const map = new mapboxgl.Map({
        container: 'map', // container ID
        style: 'mapbox://styles/mapbox/streets-v12', // style URL
        center: [-74.5, 40], // starting position [lng, lat]
        zoom: 9 // starting zoom
    });

    const renderSigns = (signs) => {
        let max = signs.length > 20 ? 20 : signs.length;

        let html = [];
      for (let i = 0; i <= max - 1; i++) {
          html.push("<div><img loading='lazy' class='h-auto max-w-full rounded-lg' src='https://pub-739418d83a5e4d54b433224deddf7675.r2.dev/" + signs[i].properties.imageid + "/" + signs[i].properties.imageid + "_s.jpg' /></div>" );
          curExtentEl.innerHTML = html.join("");
      }
    };

    let signs = [];
    let curExtentEl = document.getElementById("images-current-extent");

    map.on('init', () => {
        map.resize();
    });

    map.on('moveend', () => {
        const features = map.queryRenderedFeatures({layers: ['sign']});

        if (features) {
            renderSigns(features);
        }
    });

    map.on("load", () => {
        map.addSource('signs', {
            type: 'vector',
            tiles: ['http://localhost:8080/services/signs/tiles/{z}/{x}/{y}.pbf'],
            minzoom: 0,
            maxzoom: 16
        });
        map.addLayer({
            id: "sign",
            type: "circle",
            source: "signs",
            "source-layer": "sign",
            paint: {
                "circle-radius": 8,
                "circle-color": "rgba(55,148,179,1)",
            },
        });
    });

</script>
{{ end }}